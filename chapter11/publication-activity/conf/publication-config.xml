<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesource.org/schema/mule/core/2.1"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns:http="http://www.mulesource.org/schema/mule/http/2.1"
		xmlns:vm="http://www.mulesource.org/schema/mule/vm/2.1"
		xmlns:jms="http://www.mulesource.org/schema/mule/jms/2.1"
		xmlns:xm="http://www.mulesource.org/schema/mule/xml/2.1"
		xmlns:spring="http://www.springframework.org/schema/beans"
		xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
					http://www.mulesource.org/schema/mule/core/2.1 http://www.mulesource.org/schema/mule/core/2.1/mule.xsd
					http://www.mulesource.org/schema/mule/jms/2.1 http://www.mulesource.org/schema/mule/jms/2.1/mule-jms.xsd
					http://www.mulesource.org/schema/mule/http/2.1 http://www.mulesource.org/schema/mule/http/2.1/mule-http.xsd
					http://www.mulesource.org/schema/mule/vm/2.1 http://www.mulesource.org/schema/mule/vm/2.1/mule-vm.xsd
					http://www.mulesource.org/schema/mule/xml/2.1 http://www.mulesource.org/schema/mule/xml/2.1/mule-xml.xsd">
	
	<spring:bean id="propertyConfigurer"
	    class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
	    <spring:property name="location" value="publication.properties" />
	    <spring:property name="placeholderPrefix" value="$[" />
	    <spring:property name="placeholderSuffix" value="]" />
	</spring:bean>

	<spring:beans>
		<spring:import resource="management-config.xml"/>
		<spring:import resource="favicon-config.xml"/>
		<spring:import resource="publication-jms-config.xml"/>
	</spring:beans>

	<vm:endpoint name="DocumentChannel" path="document.channel"  synchronous="false" />
	
	<object-to-string-transformer name="ObjectToString" />

	<jms:object-to-jmsmessage-transformer name="ObjectToJmsMessage" />
	
	<xm:xslt-transformer name="DocbookToFO"	xsl-file="docbook-fo.xsl" />
	
	<model name="publicationModel">
		<service name="publicationService">
			<inbound>
				<http:inbound-endpoint address="http://$[esb.bind.address]:$[esb.web.port]/publicationService">
					<response-transformers>
						<expression-transformer>
							<return-argument evaluator="groovy" expression="'ACK'"/>
						</expression-transformer>						
					</response-transformers>
				</http:inbound-endpoint>
			</inbound>
			<outbound>
				<pass-through-router>
					<outbound-endpoint ref="DocumentChannel">
						<transformer ref="ObjectToString" />
					</outbound-endpoint>
				</pass-through-router>
			</outbound>
		</service>
		<service name="documentProcessor">
			<inbound>
				<inbound-endpoint ref="DocumentChannel" />
				<!-- <start id="Activity-Wiretap"/> -->
				<wire-tap-router>
					<outbound-endpoint ref="AuditChannel">
						<expression-transformer>
							<return-argument
									evaluator="groovy"
									expression="'Uploaded title: '+org.apache.commons.lang.StringUtils.substringBetween(payload,'&lt;title&gt;','&lt;/title&gt;')"/>
						</expression-transformer>
					</outbound-endpoint>
				</wire-tap-router>
				<!-- <end id="Activity-Wiretap"/> -->
			</inbound>
			<outbound>
				<pass-through-router>
					<jms:outbound-endpoint queue="publicationQueue"	connector-ref="publicationJmsConnector">
						<transformer ref="DocbookToFO" />
						<transformer ref="ObjectToString" />
						<transformer ref="ObjectToJmsMessage" />
					</jms:outbound-endpoint>
				</pass-through-router>
			</outbound>
		</service>
	</model>
</mule>
