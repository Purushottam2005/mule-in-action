<process-definition name="AccountProvisioning"
                    xmlns="http://jbpm.org/3/jpdl"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://jbpm.org/3/jpdl http://jbpm.org/jpdl-3.1.xsd"
        >

    <start-state name="Account Provisioning">
        <action class="org.mule.transport.bpm.jbpm.actions.ValidateMessageSource">
            <expectedSource>startProvisionRequest</expectedSource>
        </action>

        <action class="org.mule.transport.bpm.jbpm.actions.StoreIncomingData">
            <variable>incoming</variable>
        </action>
        <transition to='Create LDAP Account'/>
    </start-state>

    <state name='Create LDAP Account'>
        <event type="node-enter">
            <action class="org.mule.transport.bpm.jbpm.actions.SendMuleEventAndContinue">
                <endpoint>jms://it.provisioning.ldap</endpoint>
                <payloadSource>incoming</payloadSource>
                <synchronous>false</synchronous>
            </action>
        </event>
        <transition to='Create Hour Entry Account'/>
    </state>

    <state name='Create Hour Entry Account'>
        <event type="node-enter">
            <action class="org.mule.transport.bpm.jbpm.actions.SendMuleEventAndContinue">
                <endpoint>jms://it.provisioning.hour-entry</endpoint>
                <payloadSource>incoming</payloadSource>
                <synchronous>false</synchronous>
            </action>
        </event>
        <transition to='Check Group'/>
    </state>

    <decision name="Check Group">
        <handler class="com.clood.it.ResolveGroup"/>
        <transition name="Operations" to="Create SSH Account"/>
        <transition name="Sales" to="Create CRM Account"/>
    </decision>

    <state name='Create SSH Account'>
        <event type="node-enter">
            <action class="org.mule.transport.bpm.jbpm.actions.SendMuleEventAndContinue">
                <endpoint>jms://it.provisioning.ssh</endpoint>
                <payloadSource>incoming</payloadSource>
                <synchronous>false</synchronous>
            </action>
        </event>
        <transition to="Create IMAP Account"/>
    </state>

    <state name='Create CRM Account'>
        <event type="node-enter">
            <action class="org.mule.transport.bpm.jbpm.actions.SendMuleEventAndContinue">
                <endpoint>jms://it.provisioning.crm</endpoint>
                <payloadSource>incoming</payloadSource>
                <synchronous>false</synchronous>
            </action>
        </event>
        <transition to="Create IMAP Account"/>
    </state>

    <state name='Create IMAP Account'>
        <event type="node-enter">
            <action class="org.mule.transport.bpm.jbpm.actions.SendMuleEventAndContinue">
                <endpoint>jms://it.provisioning.imap</endpoint>
                <payloadSource>incoming</payloadSource>
                <synchronous>false</synchronous>
            </action>
        </event>
        <transition to='Send Email Confirmation'/>
    </state>

    <state name='Send Email Confirmation'>
        <event type="node-enter">
            <action class="org.mule.transport.bpm.jbpm.actions.SendMuleEvent">
                <endpoint>SendEmailConfirmationEndpoint</endpoint>
                <payloadSource>incoming</payloadSource>
                <synchronous>false</synchronous>
            </action>
        </event>
        <transition name="continue" to='end'/>

    </state>

    <end-state name='end'>
        <event type="node-enter">
            <script>
                System.out.println("Account Provisioned");
            </script>
        </event>
    </end-state>
   
</process-definition>

